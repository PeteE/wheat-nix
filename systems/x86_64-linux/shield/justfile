# NixOS Shield Azure Deployment Justfile
# vim: ts=4:sw=4:et

# Default target - list available recipes
default:
    @just --list

# Build the Azure VHD image
build:
    @echo "ğŸ—ï¸  Building NixOS Shield Azure VHD image..."
    @echo "ğŸ“¦ Starting Nix build process - this might take a while!"
    cd ../../.. && nix build --builders '' .#nixosConfigurations.shield.config.formats.azure
    @echo ""
    @echo "âœ¨ VHD image built successfully!"
    @echo "ğŸ¯ Image location: $(realpath ../../../result/nixos-image-azure-*.vhd)"
    @echo "ğŸ“Š Image size: $(du -h ../../../result/nixos-image-azure-*.vhd | cut -f1)"
    @echo "ğŸš€ Ready for upload to Azure!"

# Build and upload VHD to Azure storage
upload: build
    @echo ""
    @echo "â¬†ï¸  Starting VHD upload to Azure..."
    @echo "ğŸŒŠ Surfing the cloud waves with your fresh NixOS image!"
    ./deploy-azure.sh --subscription cba69f50-0a97-4d1d-8272-17ec79b32a7e \
                      --resource-group shield-nixos-rg \
                      --storage-account shieldnixosstorage \
                      --location westus \
                      --vm-name nixos-shield-vm \
                      --overwrite
    @echo ""
    @echo "ğŸ‰ Upload complete! Your VHD is now chillin' in Azure storage."
    @echo "ğŸ’¾ Ready to transform into a virtual machine!"

# Deploy VM from uploaded VHD
deploy:
    @echo ""
    @echo "ğŸ–¥ï¸  Deploying NixOS Shield VM..."
    @echo "âš¡ Time to bring your NixOS creation to life!"
    ./deploy-azure.sh deploy \
                     --subscription cba69f50-0a97-4d1d-8272-17ec79b32a7e \
                     --resource-group shield-nixos-rg \
                     --storage-account shieldnixosstorage \
                     --location westus \
                     --vm-name nixos-shield-vm \
                     --vm-size Standard_B2s \
                     --overwrite
    @echo ""
    @echo "ğŸŠ VM deployment complete!"
    @echo "ğŸ”‘ SSH into your new NixOS machine:"
    @echo "   ssh opadmin@$$(az vm show -d -g shield-nixos-rg -n nixos-shield-vm --query publicIps -o tsv)"

# Destroy all Azure resources
destroy:
    @echo "ğŸ’€ Destroying all Azure resources..."
    @echo "ğŸ§¹ Time for some cloud cleanup!"
    ./deploy-azure.sh destroy \
                     --subscription cba69f50-0a97-4d1d-8272-17ec79b32a7e \
                     --resource-group shield-nixos-rg \
                     --storage-account shieldnixosstorage \
                     --vm-name nixos-shield-vm
    @echo ""
    @echo "ğŸ’¨ All resources have been sent to the digital void!"
    @echo "ğŸ’° Your Azure bill just got lighter!"

# Show help
help:
    @echo "ğŸ›¡ï¸  NixOS Shield Azure Deployment"
    @echo ""
    @echo "Available commands:"
    @echo "  just build     - Build the NixOS Azure VHD image"
    @echo "  just upload    - Build and upload VHD to Azure storage"
    @echo "  just deploy    - Deploy VM from VHD"
    @echo "  just destroy   - Destroy all Azure resources"
    @echo "  just help      - Show this help"
    @echo ""
    @echo "ğŸ”— Full workflow: just upload && just deploy"


